<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Micro-Crèche</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/styles.css">
    </head>
    <body>
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">Micro-Crèche</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <% if (user) { %>
                            <li class="nav-item">
                                <div class="d-flex align-items-center">
                                    <img src="/path/to/user-icon.png" alt="User" style="width: 30px; height: 30px; border-radius: 50%;">
                                    <span class="ms-2"><%= user.prenom %> <%= user.nom %></span>
                                </div>
                            </li>
                            <li class="nav-item"><a class="nav-link" href="/planning">Planning</a></li>
                            <li class="nav-item"><a class="nav-link" href="/employes">Employés</a></li>
                            <li class="nav-item"><a class="nav-link" href="/enfants">Enfants</a></li>
                            <li class="nav-item"><a class="nav-link" href="/auth/logout">Déconnexion</a></li>
                        <% } else { %>
                            <li class="nav-item"><a class="nav-link" href="/auth/signup/employe">Créer un compte Employé</a></li>
                            <li class="nav-item"><a class="nav-link" href="/auth/signup/pro">Créer un compte Pro</a></li>
                            <li class="nav-item"><a class="nav-link" href="/auth/login">Connexion</a></li>
                        <% } %>
                    </ul>
                </div>                
            </div>
        </nav>

        <!-- Presentation -->
        <div class="presentation">
            Bienvenue sur Micro-Crèche ! Créez et gérez vos micro-crèches en toute simplicité.
        </div>

        <!-- Blocs -->
        <section id="home">
            <div class="container mt-5">
                <div class="row text-center">
                    <div class="col-md-4">
                        <div class="card card-bg" id="block1">
                            <div class="card-body">
                                <h5 class="card-title">Créer une micro-crèche</h5>
                                <div class="card-text">
                                    <p>Créez votre propre micro-crèche et ajoutez toutes les informations nécessaires.</p>
                                </div>
                                <a href="/micro-creche/create" class="btn btn-primary">Accéder</a>
                              </div>                              
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-bg" id="block2">
                            <div class="card-body">
                                <h5 class="card-title">Ajouter des employés</h5>
                                <div class="card-text">
                                    <p>Ajoutez facilement vos employés et gérez leur emploi du temps.</p>
                                </div>
                                <a href="/employee/add" class="btn btn-primary">Accéder</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-bg" id="block3">
                            <div class="card-body">
                                <h5 class="card-title">Ajouter des enfants</h5>
                                <div class="card-text">
                                    <p>Inscrivez les enfants et suivez leurs présences.</p>
                                </div>
                                <a href="/child/add" class="btn btn-primary">Accéder</a>
                            </div>
                        </div>
                    </div>
                    <% if (user) { %>
                        <div class="col-md-4">
                            <div class="card card-bg" id="block4">
                                <div class="card-body">
                                    <h5 class="card-title">Votre profil</h5>
                                    <div class="card-text">
                                        <p>Consultez et modifiez votre profil, gérez vos informations personnelles et vos micro-crèches.</p>
                                    </div>
                                    <a href="/profile" class="btn btn-primary">Accéder</a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card card-bg" id="block5">
                                <div class="card-body">
                                    <h5 class="card-title">Vos micro-crèches</h5>
                                    <div class="card-text">
                                        <p>Consultez et gérez toutes vos micro-crèches. Modifiez les informations, ajoutez des enfants ou des employés, et accédez à leurs détails.</p>
                                    </div>
                                    <a href="/micro-creche" class="btn btn-primary">Accéder</a>
                                </div>
                            </div>
                        </div>
        
                        <div class="col-md-4">
                            <div class="card card-bg" id="block6">
                                <div class="card-body">
                                    <h5 class="card-title">Vos employés</h5>
                                    <div class="card-text">
                                        <p>Consultez et gérez tous vos employés. Modifiez leurs informations, leur emploi du temps et leurs rôles.</p>
                                    </div>
                                    <a href="/employee" class="btn btn-primary">Accéder</a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card card-bg" id="block7">
                                <div class="card-body">
                                    <h5 class="card-title">Vos enfants</h5>
                                    <div class="card-text">
                                        <p>Consultez et gérez tous les enfants inscrits dans vos micro-crèches. Modifiez leurs informations et leurs présences.</p>
                                    </div>
                                    <a href="/child" class="btn btn-primary">Accéder</a>
                                </div>
                            </div>
                        </div>
                    <% } %>    
                </div>
            </div>
        </section>

        <!-- Section Planning -->
        <section id="planning" class="py-5">
            <div class="container text-center">
                <h2 class="mb-4">Consultez vos plannings</h2>
            
                <!-- Cas : utilisateur non authentifié -->
                <% if (!userAuthenticated) { %>
                    <p>Connectez-vous ou créez un compte pour accéder à vos plannings.</p>
            
                <!-- Cas : aucune micro-crèche éligible -->
                <% } else if (eligibleMicroCreches.length === 0) { %>
                    <p>Ajoutez des enfants et des employés à vos micro-crèches pour générer un planning.</p>
            
                <!-- Cas : plannings disponibles ou génération possible -->
                <% } else { %>
                    <div>
                        <% if (plannings && plannings.length > 0) { %>
                            <div class="container my-5">
                              
                                <div id="carousel-planning" class="carousel slide" data-bs-ride="carousel">
                                    <div class="carousel-inner">
                                      <% plannings.forEach((planning, index) => { %>
                                        <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
                                          <h4 class="text-center mb-4">Planning pour : <%= planning.microCreche.name %></h4>
                                          <table class="table table-bordered text-center">
                                            <thead>
                                              <tr>
                                                <th>Heure</th>
                                                <% daysOfWeek.forEach(day => { %>
                                                  <th><%= day %></th>
                                                <% }); %>
                                              </tr>
                                            </thead>
                                            <tbody>
                                              <% for (let hour = 6; hour < 20; hour++) { %>
                                                <tr>
                                                  <td><%= hour %>:00 - <%= hour + 1 %>:00</td>
                                                  <% daysOfWeek.forEach(day => { %>
                                                    <% 
                                                      const slot = planning.slots.find(
                                                        s => s.day.toLowerCase() === day.toLowerCase() && s.start === `${hour}:00`
                                                      );
                                                      const childrenCount = slot?.children.length || 0;
                                                      const bgColor =
                                                        childrenCount === 1 ? 'bg-blue' :
                                                        childrenCount === 2 ? 'bg-orange' :
                                                        childrenCount >= 3 ? 'bg-red' : '';
                                                    %>
                                                    <td class="rounded-cell <%= bgColor %>">
                                                      <% if (slot) { %>
                                                        <% if (slot.children.length > 0) { %>
                                                          <div class="slot-details">
                                                            <strong>Enfants :</strong>
                                                            <% slot.children.forEach(child => { %>
                                                              <p class="child-name"><%= child.name %></p>
                                                            <% }); %>
                                                          </div>
                                                        <% } %>
                                                        <% if (slot.employees.length > 0) { %>
                                                          <div class="slot-details">
                                                            <strong>Employés :</strong>
                                                            <% slot.employees.forEach(emp => { %>
                                                              <p class="employee-name"><%= emp.name %></p>
                                                            <% }); %>
                                                          </div>
                                                        <% } %>
                                                        <% if (slot.missingEmployees > 0) { %>
                                                          <p class="text-danger fw-bold">Employés manquants : <%= slot.missingEmployees %></p>
                                                        <% } %>
                                                      <% } %>
                                                    </td>
                                                  <% }); %>
                                                </tr>
                                              <% } %>
                                            </tbody>
                                          </table>
                                        </div>
                                      <% }); %>
                                    </div>
                              
                                  <!-- Navigation -->
                                  <button class="carousel-control-prev" type="button" data-bs-target="#carousel-planning" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Précédent</span>
                                  </button>
                                  <button class="carousel-control-next" type="button" data-bs-target="#carousel-planning" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Suivant</span>
                                  </button>
                                  <div class="d-flex justify-content-start align-items-center mb-4">
                                    <div class="me-3">
                                      <span class="legend-box bg-blue"></span> 1 enfant
                                    </div>
                                    <div class="me-3">
                                      <span class="legend-box bg-orange"></span> 2 enfants
                                    </div>
                                    <div>
                                      <span class="legend-box bg-red"></span> 3 enfants ou plus
                                    </div>
                                  </div>

                                </div>
                              </div>
                              
                          <% } else { %>
                            <p>Aucun planning disponible.</p>
                          <% } %>
                          
                        <!-- Bouton pour générer un nouveau planning -->
                        <button class="btn btn-primary mt-4" data-bs-toggle="modal" data-bs-target="#selectMicroCrecheModal">
                            Générer un nouveau planning
                        </button>
                        
                        <!-- Modale pour sélectionner une micro-crèche -->
                        <div class="modal fade" id="selectMicroCrecheModal" tabindex="-1" aria-labelledby="selectMicroCrecheModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="selectMicroCrecheModalLabel">Sélectionnez une micro-crèche</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <ul class="list-group">
                                            <% eligibleMicroCreches.forEach((mc) => { %>
                                                <li class="list-group-item">
                                                    <%= mc.name %>
                                                    <button class="btn btn-sm btn-success float-end" onclick="generatePlanning('<%= mc._id %>')">
                                                    Générer
                                                    </button>
                                                </li>
                                            <% }); %>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                <% } %>
            </div>
        </section>
                  
            <script>
                function generatePlanning(microCrecheId) {
                    fetch(`/generate-planning/${microCrecheId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                        alert("Planning généré avec succès !");
                        location.reload(); // Recharge la page pour afficher le nouveau planning
                        } else {
                        alert(`Erreur : ${data.message}`);
                        }
                    })
                    .catch(() => {
                        alert("Une erreur est survenue.");
                    });
                }
            </script>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>
